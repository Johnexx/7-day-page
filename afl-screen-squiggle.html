<script>
  const teamTimeOffsets = {
    "West Coast": 0,
    "Fremantle": 0,
    "Adelaide": 2,
    "Port Adelaide": 2,
    "Brisbane Lions": 2,
    "Gold Coast": 2,
    "Sydney": 2,
    "Greater Western Sydney": 2,
    "Melbourne": 2,
    "Western Bulldogs": 2,
    "Hawthorn": 2,
    "Collingwood": 2,
    "Carlton": 2,
    "Essendon": 2,
    "St Kilda": 2,
    "Richmond": 2,
    "Geelong": 2,
    "North Melbourne": 2,
  };

  function getTeamLogoUrl(teamName) {
    const logoMap = {
      "Richmond": "richmond.png",
      "Western Bulldogs": "western_bulldogs.png",
      "Gold Coast": "suns.png",
      "Collingwood": "collingwood.png",
      "St Kilda": "st_kilda.png",
      "Fremantle": "fremantle_dockers.png",
      "Brisbane Lions": "brisbane_lions.png",
      "North Melbourne": "north_melbourne.png",
      "Port Adelaide": "port_adelaide.png",
      "Geelong": "geelong_cats.png",
      "Essendon": "essendon.png",
      "Carlton": "carlton.png",
      "Sydney": "sydney_swans.png",
      "Greater Western Sydney": "giants.png",
      "Adelaide": "adelaide_crows.png",
      "Hawthorn": "hawks.png",
      "Melbourne": "melbourne.png",
      "West Coast": "west_coast.png"
    };
    const fileName = logoMap[teamName] || `${teamName.replace(/\s+/g, '').toLowerCase()}.png`;
    return `/afl-logos/${fileName}`;
  }

  function buildMatchCard(game, date) {
    const hteam = game.getElementsByTagName("hteam")[0]?.textContent || "";
    const hscore = parseInt(game.getElementsByTagName("hscore")[0]?.textContent || "0");
    const ateam = game.getElementsByTagName("ateam")[0]?.textContent || "";
    const ascore = parseInt(game.getElementsByTagName("ascore")[0]?.textContent || "0");
    const timestr = game.getElementsByTagName("timestr")[0]?.textContent || "";
    const hasScore = ascore > 0 || hscore > 0;

    let hours = date.getHours();
    let minutes = date.getMinutes();
    const ampm = hours >= 12 ? "PM" : "AM";
    hours = hours % 12 || 12;
    minutes = minutes.toString().padStart(2, '0');
    const timeOnly = `${hours}.${minutes}${ampm}`;

    const statusDisplay = timestr.startsWith("Q")
      ? timestr.split(" ")[0]
      : (hasScore ? "Result" : timeOnly);

    const card = document.createElement("div");
    card.className = "match";
    card.innerHTML = `
      <div class="teams">
        <div class="team" style="color: ${hasScore ? (hscore > ascore ? 'green' : (hscore < ascore ? 'red' : '#1a3b8d')) : ''}">
          ${hasScore ? hscore : ""}
        </div>
        <div class="logo"><img src="${getTeamLogoUrl(hteam)}" alt="${hteam} Logo"></div>
        <div class="team">
          <div>vs</div>
          <div class="time">${statusDisplay}</div>
        </div>
        <div class="logo"><img src="${getTeamLogoUrl(ateam)}" alt="${ateam} Logo"></div>
        <div class="team" style="color: ${hasScore ? (ascore > hscore ? 'green' : (ascore < hscore ? 'red' : '#1a3b8d')) : ''}">
          ${hasScore ? ascore : ""}
        </div>
      </div>
    `;
    return card;
  }

  fetch('/.netlify/functions/squiggle')
    .then(res => res.text())
    .then(xmlString => {
      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlString, "application/xml");
      const gameNodes = Array.from(xml.getElementsByTagName("anon"));

      const grouped = {};
      const results = [];

      for (let game of gameNodes) {
        const hteam = game.getElementsByTagName("hteam")[0]?.textContent || "";
        const dateRaw = game.getElementsByTagName("date")[0]?.textContent;
        const timestr = game.getElementsByTagName("timestr")[0]?.textContent || "";

        const date = new Date(dateRaw);

        // Subtract 2 hours ONLY for West Coast and Fremantle
        if (hteam === "West Coast" || hteam === "Fremantle") {
          date.setHours(date.getHours() - 2);
        } else {
          const offset = teamTimeOffsets[hteam] ?? 0;
          date.setHours(date.getHours() - offset);
        }

        if (timestr === "Full Time") {
          results.push({ game, date });
        } else {
          const dayName = date.toLocaleDateString("en-AU", { weekday: "long", day: "numeric", month: "short" });
          if (!grouped[dayName]) grouped[dayName] = [];
          grouped[dayName].push({ game, date });
        }
      }

      const output = document.getElementById("schedule");
      output.innerHTML = "";

      for (const [dayName, schedule] of Object.entries(grouped)) {
        const daySection = document.createElement("div");
        daySection.className = "day-group";
        daySection.innerHTML = `<div class="day-heading">${dayName}</div>`;
        for (let { game, date } of schedule) {
          daySection.appendChild(buildMatchCard(game, date));
        }
        output.appendChild(daySection);
      }

      if (results.length > 0) {
        const resultSection = document.createElement("div");
        resultSection.className = "day-group";
        resultSection.innerHTML = `<div class="day-heading">Results</div>`;
        for (let { game, date } of results) {
          resultSection.appendChild(buildMatchCard(game, date));
        }
        output.appendChild(resultSection);
      }
    })
    .catch(err => {
      console.error("Failed to load or parse XML:", err);
      document.getElementById("schedule").textContent = "Failed to load schedule.";
    });
</script>
